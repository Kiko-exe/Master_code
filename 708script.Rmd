---
title: "data paper"
author: "Yuehan Luo"
date: "2025-09-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(patchwork)

path <- "ENVSCI 708_Data_Collaborative Research Project.xlsx"

df <- read_excel(path, sheet = 1)

```

```{r}

library(tidyverse)

names(df) <- df |>
  names() |>
  gsub("\u00A0", " ", x = _) |>
  trimws()

df_box <- df %>%
  mutate(
    Habitat = case_when(
      str_starts(tolower(`Name of location`), "forest") ~ "Forest",
      str_starts(tolower(`Name of location`), "lawn")   ~ "Grassland",
      TRUE ~ NA_character_
    )
  ) %>%
  select(
    Habitat,
    `Soil temperature (°C)`,
    `Light Intensity (μmol/m²/s)`,
    `Soil volumetric water content (%)`
  ) %>%
  pivot_longer(
    cols = -Habitat,
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  drop_na(Habitat, Value)

p <- ggplot(df_box, aes(x = Habitat, y = Value, fill = Habitat)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.85, width = 0.6) +
  geom_jitter(aes(color = Habitat), width = 0.12, alpha = 0.45, size = 1.6) +
  facet_wrap(~ Variable, scales = "free_y", nrow = 1) +
  labs(
    title = "Forest vs Grassland — Soil Temp / PAR / SWC",
    x = NULL, y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")

print(p)
```

```{r}
df_swc <- df %>%
  mutate(
    Habitat = case_when(
      str_starts(tolower(`Name of location`), "forest") ~ "Forest",
      str_starts(tolower(`Name of location`), "lawn")   ~ "Grassland",
      TRUE ~ NA_character_
    )
  ) %>%
  transmute(
    Canopy = as.numeric(`Canopy cover (%)`),
    SWC    = as.numeric(`Soil volumetric water content (%)`),
    SoilTemp = as.numeric(`Soil temperature (°C)`),
    Habitat
  ) %>%
  drop_na(Canopy, SWC, SoilTemp)

r_txt <- tryCatch({
  r <- cor(df_swc$Canopy, df_swc$SWC, use = "pairwise.complete.obs")
  sprintf("Pearson r = %.2f", r)
}, error = function(e) NULL)

p_swc <- ggplot(df_swc, aes(Canopy, SWC, colour = Habitat)) +
  geom_point(size = 2, alpha = 0.85) +
  geom_smooth(method = "lm", se = FALSE, colour = "black", linewidth = 0.9) +
  labs(
    title = "Canopy cover vs Soil volumetric water content",
    subtitle = r_txt,
    x = "Canopy cover (%)",
    y = "Soil volumetric water content (%)"
  ) +
  theme_minimal(base_size = 12)

print(p_swc)


r_txt <- tryCatch({
  r <- cor(df_swc$Canopy, df_swc$SoilTemp, use = "pairwise.complete.obs")
  sprintf("Pearson r = %.2f", r)
}, error = function(e) NULL)

p_temp <- ggplot(df_swc, aes(Canopy, SoilTemp, colour = Habitat)) +
  geom_point(size = 2, alpha = 0.85) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.9, colour = "black") +
  labs(
    title = "Canopy cover vs Soil temperature",
    subtitle = r_txt,
    x = "Canopy cover (%)",
    y = "Soil temperature (°C)"
  ) +
  theme_minimal(base_size = 12)

print(p_temp)

```

```{r}
df_gas <- df %>%
  mutate(
    Habitat = case_when(
      str_starts(tolower(`Name of location`), "forest") ~ "Forest",
      str_starts(tolower(`Name of location`), "lawn")   ~ "Grassland",
      TRUE ~ NA_character_
    ),
    Canopy   = as.numeric(`Canopy cover (%)`),
    CO2 = as.numeric(`Greenhouse gas emissions (CO2, ppm)`),
    N2O = as.numeric(`Greenhouse gas emissions (N2O, ppm)`),
    CH4 = as.numeric(`Greenhouse gas emissions (CH4, ppm)`)
  ) %>%
  drop_na(Canopy)

p_co2 <- ggplot(df_gas, aes(Canopy, CO2, colour = Habitat)) +
  geom_point(size = 2, alpha = 0.85) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  labs(x = "Canopy Cover (%)",
       y = "CO2 (ppm)",
       title = "Canopy Cover vs CO2 emissions") +
  theme_minimal(base_size = 12)

p_n2o <- ggplot(df_gas, aes(Canopy, N2O, colour = Habitat)) +
  geom_point(size = 2, alpha = 0.85) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  labs(x = "Canopy Cover (%)",
       y = "N2O (ppm)",
       title = "Canopy Cover vs N2O emissions") +
  theme_minimal(base_size = 12)

p_ch4 <- ggplot(df_gas, aes(Canopy, CH4, colour = Habitat)) +
  geom_point(size = 2, alpha = 0.85) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  labs(x = "Canopy Cover (%)",
       y = "CH4 (ppm)",
       title = "Canopy Cover vs CH4 emissions") +
  theme_minimal(base_size = 12)


print(p_co2)

p_panel <- (p_co2 | p_n2o | p_ch4) +
  plot_annotation(
    title = "SWC vs Greenhouse gas emissions",
    subtitle = "Cross-group comparison: Soil SWC (Sensor 1) vs CO2 / N2O / CH4 (other group)",
  )

print(p_panel)
ggsave("Figure3_SWC_vs_GHG.png", p_panel, width = 12, height = 4.2, dpi = 300, bg = "white")

```

```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(sf)

dms_to_dd_one <- function(x) {
  if (is.na(x) || !nzchar(x)) return(NA_real_)
  x <- str_replace_all(x, "[\u2032']", "’")
  x <- str_replace_all(x, "[\u2033\"]", "”")
  x <- str_squish(x)
  m <- regexec("([0-9]+)\\D+([0-9]+)\\D+([0-9]+)\\D*([NSEW])", x)
  parts <- regmatches(x, m)[[1]]
  if (length(parts) == 0) return(NA_real_)
  deg <- as.numeric(parts[2])
  min <- as.numeric(parts[3])
  sec <- as.numeric(parts[4])
  dir <- parts[5]
  dd <- deg + min/60 + sec/3600
  if (dir %in% c("S","W")) dd <- -dd
  dd
}
dms_to_dd <- function(v) vapply(v, dms_to_dd_one, numeric(1))

path <- "ENVSCI 708_Data_Collaborative Research Project.xlsx"
raw <- read_excel(path)
colname <- if ("GPS location" %in% names(raw)) "GPS location" else names(raw)[1]

df <- raw %>%
  mutate(loc = as.character(.data[[colname]])) %>%
  mutate(loc = str_replace_all(loc, "[()]", "")) %>%
  separate(loc, into = c("part1","part2","rest"), sep = ",", extra = "merge", fill = "right") %>%
  mutate(part1 = str_squish(part1),
         part2 = str_squish(part2)) %>%
  mutate(
    lat = ifelse(str_detect(part1, "°"), dms_to_dd(part1), suppressWarnings(as.numeric(part1))),
    lon = ifelse(str_detect(part2, "°"), dms_to_dd(part2), suppressWarnings(as.numeric(part2)))
  ) %>%
  select(lat, lon) %>%
  filter(!is.na(lat) & !is.na(lon))

points_sf <- st_as_sf(df, coords = c("lon","lat"), crs = 4326)

p <- ggplot() +
  geom_sf(data = points_sf, size = 2) +
  coord_sf(expand = FALSE) +
  theme_minimal() +
  labs(title = "GPS Points", x = "Longitude", y = "Latitude")

print(p)
ggsave("gps_points.png", p, width = 7, height = 6, dpi = 300)

write.csv(st_drop_geometry(points_sf) |>
            mutate(lon = st_coordinates(points_sf)[,1],
                   lat = st_coordinates(points_sf)[,2]),
          "gps_points_clean.csv", row.names = FALSE)

st_write(points_sf, "gps_points.geojson", delete_dsn = TRUE)
```






